<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARKER - Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <link rel="stylesheet" href="./style.css">
  <style>
    /* =========================================
       1. GLOBAL & SETUP
       ========================================= */
    body {
        overflow: hidden;
        background-color: #f4f4f4;
        overscroll-behavior: none;
        touch-action: none; /* Prevents scrolling while drawing */
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
    }

    .playground-wrapper {
        height: 100vh;
        width: 100vw;
        position: relative;
        cursor: crosshair;
    }

    .playground-wrapper.panning {
        cursor: grab;
    }

    .playground-wrapper.panning:active {
        cursor: grabbing;
    }

    /* =========================================
       2. NAVIGATION & CONTROLS
       ========================================= */
    /* Back Button */
    .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        padding: 10px 20px;
        background: black;
        color: white;
        text-decoration: none;
        border-radius: 20px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.8rem;
        transition: background 0.3s;
    }

    .back-btn:hover {
        background: #333;
    }

    /* Mobile Menu Toggle (Hidden on Desktop) */
    .mobile-menu-toggle {
        display: none;
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 101;
        width: 44px;
        height: 44px;
        background: white;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        align-items: center;
        justify-content: center;
        color: #333;
        transition: transform 0.2s;
    }
    
    .mobile-menu-toggle:active {
        transform: scale(0.9);
    }

    /* Zoom Controls */
    .zoom-controls {
        position: absolute;
        bottom: 30px;
        left: 30px;
        display: flex;
        gap: 10px;
        z-index: 1000;
    }

    .zoom-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #ddd;
        background: white;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* =========================================
       3. UI CONTAINER (BASE STYLES)
       ========================================= */
    .playground-ui {
        position: absolute;
        top: 50%;
        left: 30px;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 15px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 60px; /* Collapsed width */
        transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), padding 0.4s ease;
        overflow: hidden;
    }

    .ui-header {
        opacity: 0;
        width: 0;
        height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease 0.1s;
    }

    .ui-header h3 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
        color: #888;
        font-weight: 700;
    }

    /* Wrapper Groups */
    .tools-group, .color-picker {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }

    /* =========================================
       4. BUTTON STYLES (SHARED)
       ========================================= */
    .tool-btn, .action-btn, .color-item {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid transparent;
        background: #f2f2f2;
        color: #666;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        transition: all 0.2s;
        position: relative;
        -webkit-tap-highlight-color: transparent;
    }

    /* Ensure no weird squares */
    .tool-btn::before, .tool-btn::after {
        display: none !important;
        content: none !important;
    }

    /* Icons */
    .tool-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        display: block;
    }

    /* Text Labels (Hidden by default on Desktop) */
    .tool-btn span, .color-item span, .action-btn span {
        display: none;
        margin-left: 12px;
        opacity: 0;
        white-space: nowrap;
        font-size: 13px;
    }

    /* Active State */
    .tool-btn.active, .color-item.active {
        background: #111;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* Clear Button Specifics */
    .action-btn {
        background: transparent;
        border-color: #eee;
        margin-top: auto;
    }
    .action-btn:hover {
        background: #d91c24;
        color: #fff;
        border-color: #d91c24;
    }

    /* Color Dot Inner Circle */
    .color-item .color-dot {
        width: 100%; 
        height: 100%;
        border-radius: 50%;
        border: 1px solid rgba(0,0,0,0.1);
        pointer-events: none;
    }

    /* =========================================
       5. DESKTOP SPECIFIC (Hover to Expand)
       ========================================= */
    @media (min-width: 769px) {
        /* Color Button Desktop Styling (Circle only) */
        .color-item {
            width: 24px;
            height: 24px;
            padding: 0;
            border-radius: 50%;
            background: transparent;
            border: 2px solid transparent;
        }
        .color-item.active {
            transform: scale(1.2);
            border-color: #000; /* Ring around active color */
            background: transparent;
        }

        /* Hover Expansion Logic */
        .playground-ui:hover {
            width: 200px;
            align-items: flex-start;
            padding: 25px;
        }

        .playground-ui:hover .ui-header {
            opacity: 1;
            width: auto;
            height: auto;
            margin-bottom: 10px;
        }

        .playground-ui:hover .color-picker {
            flex-direction: row;
            flex-wrap: wrap;
        }

        .playground-ui:hover .tool-btn {
            width: 100%;
            justify-content: flex-start;
            padding: 10px 12px;
        }

        .playground-ui:hover .tool-btn span {
            display: inline-block;
            opacity: 1;
            animation: fadeIn 0.3s ease forwards;
        }
    }

    @keyframes fadeIn {
        to { opacity: 1; transform: translateX(0); }
    }

    /* =========================================
       6. MOBILE SPECIFIC (Right Side Dropdown)
       ========================================= */
    @media (max-width: 768px) {
        
        .mobile-menu-toggle {
            display: flex;
        }

        .back-btn {
            top: 20px; left: 20px;
            padding: 12px 20px;
            z-index: 102;
        }

        /* --- DROPDOWN CONTAINER --- */
        .playground-ui {
            top: 75px; 
            right: 20px; 
            left: auto; /* Unset desktop left */
            transform: none; /* Remove desktop centering */
            
            /* KEY: Half Width of Screen */
            width: 50vw !important; 
            min-width: 160px; 
            max-width: 250px;
            
            height: auto;
            max-height: 0; /* Hidden initially */
            padding: 0 15px !important; /* No vertical padding when hidden */
            opacity: 0;
            
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important; /* Align content to left of dropdown */
            gap: 10px;
            
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            pointer-events: none;
            
            /* Smooth opening animation */
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden;
        }

        /* OPEN STATE */
        .playground-ui.is-open {
            max-height: 80vh;
            padding: 15px !important;
            opacity: 1;
            pointer-events: auto;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        /* Hide Header to keep it clean */
        .ui-header {
            display: none !important;
        }

        /* --- LIST ITEM LAYOUT --- */
        
        /* Make groups vertical */
        .color-picker, .tools-group {
            width: 100% !important;
            flex-direction: column !important;
            gap: 8px;
        }

        /* UNIFY BUTTON STYLES FOR LIST VIEW */
        .tool-btn, .color-item, .action-btn {
            width: 100% !important;
            height: auto !important;
            padding: 10px 12px !important;
            justify-content: flex-start !important; /* Align text left */
            background: transparent; /* Clean look */
            border-radius: 8px;
            border: none;
        }

        /* Force Text Visibility */
        .tool-btn span, .color-item span, .action-btn span {
            display: inline-block !important;
            opacity: 1 !important;
            margin-left: 12px;
            font-size: 12px !important; /* Small Words */
            font-weight: 500;
            color: #444;
        }

        /* Active State Mobile */
        .tool-btn.active, .color-item.active {
            background-color: #f0f0f0; /* Subtle grey highlight */
        }
        .tool-btn.active span, .color-item.active span {
            color: #000;
            font-weight: 700;
        }

        /* Mobile Color Dot sizing */
        .color-item .color-dot {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Clear Button at bottom */
        .action-btn {
            margin-top: 10px !important;
            background-color: #fff0f0;
            color: #d91c24;
        }
        .action-btn span {
            color: #d91c24;
        }

        /* Zoom Controls Centered */
        .zoom-controls {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
        }
    }
</style>
</head>

<body>
    <div class="transition-overlay"
        style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; z-index:9999; transform-origin:bottom;">
    </div>

    <a href="#" class="back-btn" onclick="goHome(event)">‚Üê Home</a>

    <button class="mobile-menu-toggle" id="mobile-toggle" onclick="toggleMobileMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <section id="drawing-playground" class="viewport-section" style="height: 100vh; padding: 0;">
        <div class="playground-wrapper" id="playground-wrapper">

            <div class="grid-layer" id="grid-layer" style="transform-origin: 0 0;"></div>

            <div class="playground-ui" id="playground-ui">
                <div class="ui-header">
                    <h3>Tools</h3>
                </div>

                <div class="color-picker">
    <button class="color-item active" data-color="#000000" title="Black">
        <div class="color-dot" style="background-color: #000000;"></div>
        <span>Black</span>
    </button>
    
    <button class="color-item" data-color="#d91c24" title="Red">
        <div class="color-dot" style="background-color: #d91c24;"></div>
        <span>Red</span>
    </button>
    
    <button class="color-item" data-color="#2b4eff" title="Blue">
        <div class="color-dot" style="background-color: #2b4eff;"></div>
        <span>Blue</span>
    </button>
    
    <button class="color-item" data-color="#00a651" title="Green">
        <div class="color-dot" style="background-color: #00a651;"></div>
        <span>Green</span>
    </button>
</div>

                <div class="tools-group">
                    <button id="btn-pan" class="tool-btn" title="Pan">
                        <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M23,5.5V20c0,2.2-1.8,4-4,4h-7.3c-1.08,0-2.1-0.43-2.85-1.19L1,14.83l3.77-3.79 c0.45-0.45,1.2-0.58,1.76-0.3l0.47,0.26V2.5C7,1.4,7.9,0.5,9,0.5S11,1.4,11,2.5V7h1V1.5C12,0.4,12.9-0.5,14-0.5S16,0.4,16,1.5V7h1 V2.5c0-1.1,0.9-2,2-2s2,0.9,2,2V7h1V5.5C22,4.4,22.9,3.5,24,3.5S26,4.4,26,5.5z"
                                transform="scale(0.8) translate(2,4)" />
                        </svg>
                        <span>Pan View</span>
                    </button>

                    <button id="btn-marker" class="tool-btn active" title="Marker">
                        <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                        </svg>
                        <span>Marker</span>
                    </button>

                    <button id="btn-eraser" class="tool-btn" title="Eraser">
                        <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M16.24 3.56l4.95 4.94c.78.79.78 2.05 0 2.84L12 20.53a4.008 4.008 0 0 1-5.66 0L2.81 17c-.78-.79-.78-2.05 0-2.84l10.6-10.6c.79-.78 2.05-.78 2.83 0z" />
                        </svg>
                        <span>Eraser</span>
                    </button>

                    <button id="btn-grid" class="tool-btn" title="Grid">
                        <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z" />
                        </svg>
                        <span>Toggle Grid</span>
                    </button>

                    <button id="btn-save" class="tool-btn" title="Save">
                        <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z" />
                        </svg>
                        <span>Save Image</span>
                    </button>
                </div>

                <button id="btn-clear" class="action-btn" title="Clear">
                    <svg class="tool-icon" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    <span>Clear Canvas</span>
                </button>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" id="btn-zoom-out" title="Zoom Out">-</button>
                <button class="zoom-btn" id="btn-zoom-reset" title="Reset">100%</button>
                <button class="zoom-btn" id="btn-zoom-in" title="Zoom In">+</button>
            </div>

            <canvas id="playground-canvas"></canvas>
        </div>
    </section>

    <script>
        // --- MOBILE MENU TOGGLE LOGIC ---
        function toggleMobileMenu() {
            const ui = document.getElementById('playground-ui');
            const toggleBtn = document.getElementById('mobile-toggle');
            
            ui.classList.toggle('is-open');
            
            // Icon Swap (Menu <-> Close)
            if(ui.classList.contains('is-open')) {
                toggleBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            } else {
                toggleBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
            }
        }

        // Close when clicking outside
        document.getElementById('playground-wrapper').addEventListener('touchstart', (e) => {
            if (!e.target.closest('.playground-ui') && !e.target.closest('.mobile-menu-toggle')) {
                const ui = document.getElementById('playground-ui');
                const toggleBtn = document.getElementById('mobile-toggle');
                if (ui.classList.contains('is-open')) {
                    ui.classList.remove('is-open');
                    toggleBtn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
                }
            }
        });

        // ----------------------------------------------------
        // LOGIC FOR DRAWING & ZOOMING
        // ----------------------------------------------------
        function initPlayground() {
            const canvas = document.getElementById('playground-canvas');
            const container = document.getElementById('playground-wrapper');
            const gridLayer = document.getElementById('grid-layer');
            const zoomLabel = document.getElementById('btn-zoom-reset');

            if (!canvas || !container) return;

            const ctx = canvas.getContext('2d');

            let strokes = []; 
            let currentStroke = null;
            let camera = { x: 0, y: 0, zoom: 1 };
            let isDragging = false;
            let lastMouse = { x: 0, y: 0 };
            let activeTool = 'marker';
            let currentColor = '#000000';
            let currentSize = 6;
            let isEraser = false; 

            function resize() {
                const dpr = window.devicePixelRatio || 1;
                const rect = container.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                render();
            }
            window.addEventListener('resize', resize);
            resize(); 

            function toWorld(screenX, screenY) {
                const dpr = window.devicePixelRatio || 1;
                return {
                    x: (screenX * dpr - camera.x) / camera.zoom,
                    y: (screenY * dpr - camera.y) / camera.zoom
                };
            }

            function render() {
                const dpr = window.devicePixelRatio || 1;
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.restore();

                ctx.save();
                ctx.translate(camera.x, camera.y);
                ctx.scale(camera.zoom, camera.zoom);

                strokes.forEach(stroke => drawStroke(stroke));
                if (currentStroke) drawStroke(currentStroke);

                ctx.restore();

                if (gridLayer) {
                    gridLayer.style.backgroundSize = `${40 * camera.zoom}px ${40 * camera.zoom}px`;
                    gridLayer.style.backgroundPosition = `${camera.x / dpr}px ${camera.y / dpr}px`;
                }
                if (zoomLabel) zoomLabel.innerText = Math.round(camera.zoom * 100) + "%";
            }

            function drawStroke(stroke) {
                if (stroke.points.length < 1) return;
                ctx.lineWidth = stroke.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                if (stroke.isEraser) {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = stroke.size * 8; 
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = stroke.color;
                }
                ctx.beginPath();
                const p0 = stroke.points[0];
                ctx.moveTo(p0.x, p0.y);
                if (stroke.points.length < 3) {
                    ctx.lineTo(p0.x, p0.y);
                    ctx.stroke();
                    return;
                }
                for (let i = 1; i < stroke.points.length - 2; i++) {
                    const c = (stroke.points[i].x + stroke.points[i + 1].x) / 2;
                    const d = (stroke.points[i].y + stroke.points[i + 1].y) / 2;
                    ctx.quadraticCurveTo(stroke.points[i].x, stroke.points[i].y, c, d);
                }
                const i = stroke.points.length - 2;
                ctx.quadraticCurveTo(stroke.points[i].x, stroke.points[i].y, stroke.points[i + 1].x, stroke.points[i + 1].y);
                ctx.stroke();
            }

            function getPointerPos(e) {
                const rect = container.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            let initialPinchDist = null;
            let lastPinchZoom = 1;

            function getPinchDist(e) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                return Math.hypot(dx, dy);
            }

            function getPinchCenter(e) {
                const rect = container.getBoundingClientRect();
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                return { x: cx - rect.left, y: cy - rect.top };
            }

            function handleStart(e) {
                if (e.target.closest('.playground-ui') || e.target.closest('.zoom-controls') || e.target.closest('.back-btn') || e.target.closest('.mobile-menu-toggle')) return;
                e.preventDefault();
                if (e.touches && e.touches.length === 2) {
                    initialPinchDist = getPinchDist(e);
                    lastPinchZoom = camera.zoom;
                    isDragging = false; 
                    return;
                }
                const pos = getPointerPos(e);
                lastMouse = pos;
                isDragging = true;
                if (activeTool === 'pan' || (e.button === 1) || (e.type === 'mousedown' && e.shiftKey)) {
                    container.classList.add('panning');
                    return;
                }
                const worldPos = toWorld(pos.x, pos.y);
                currentStroke = { points: [worldPos], color: currentColor, size: currentSize, isEraser: isEraser };
                render();
            }

            function handleMove(e) {
                e.preventDefault();
                if (e.touches && e.touches.length === 2 && initialPinchDist) {
                    const dist = getPinchDist(e);
                    const center = getPinchCenter(e);
                    const dpr = window.devicePixelRatio || 1;
                    const scale = dist / initialPinchDist;
                    let newZoom = lastPinchZoom * scale;
                    newZoom = Math.min(Math.max(newZoom, 0.1), 5);
                    const wx = (center.x * dpr - camera.x) / camera.zoom;
                    const wy = (center.y * dpr - camera.y) / camera.zoom;
                    camera.x = center.x * dpr - wx * newZoom;
                    camera.y = center.y * dpr - wy * newZoom;
                    camera.zoom = newZoom;
                    render();
                    return;
                }
                if (!isDragging) return;
                const pos = getPointerPos(e);
                if (activeTool === 'pan' || container.classList.contains('panning')) {
                    const dpr = window.devicePixelRatio || 1;
                    const dx = (pos.x - lastMouse.x) * dpr;
                    const dy = (pos.y - lastMouse.y) * dpr;
                    camera.x += dx;
                    camera.y += dy;
                    lastMouse = pos;
                    render();
                    return;
                }
                const worldPos = toWorld(pos.x, pos.y);
                if (currentStroke) { currentStroke.points.push(worldPos); render(); }
                lastMouse = pos;
            }

            function handleEnd(e) {
                if (e.touches && e.touches.length < 2) initialPinchDist = null;
                if (currentStroke) { strokes.push(currentStroke); currentStroke = null; }
                isDragging = false;
                container.classList.remove('panning');
                render();
            }

            function handleWheel(e) {
                e.preventDefault();
                const zoomIntensity = 0.1;
                const direction = e.deltaY > 0 ? -1 : 1;
                const factor = 1 + (direction * zoomIntensity);
                const pos = getPointerPos(e);
                const dpr = window.devicePixelRatio || 1;
                const wx = (pos.x * dpr - camera.x) / camera.zoom;
                const wy = (pos.y * dpr - camera.y) / camera.zoom;
                let newZoom = camera.zoom * factor;
                newZoom = Math.min(Math.max(newZoom, 0.1), 5);
                camera.x = pos.x * dpr - wx * newZoom;
                camera.y = pos.y * dpr - wy * newZoom;
                camera.zoom = newZoom;
                render();
            }

            container.addEventListener('mousedown', handleStart);
            window.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            container.addEventListener('touchstart', handleStart, { passive: false });
            container.addEventListener('touchmove', handleMove, { passive: false });
            container.addEventListener('touchend', handleEnd);
            container.addEventListener('wheel', handleWheel, { passive: false });

            const btnMarker = document.getElementById('btn-marker');
            const btnEraser = document.getElementById('btn-eraser');
            const btnPan = document.getElementById('btn-pan');
            const btns = [btnMarker, btnEraser, btnPan];
            const colorItems = document.querySelectorAll('.color-item');

            function activateTool(name) {
                activeTool = name;
                btns.forEach(b => b.classList.remove('active'));
                container.style.cursor = 'crosshair';
                if (name === 'marker') {
                    btnMarker.classList.add('active');
                    isEraser = false;
                    container.style.cursor = 'crosshair';
                } else if (name === 'eraser') {
                    btnEraser.classList.add('active');
                    isEraser = true;
                    const eraserSvg = `<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='none' stroke='black' stroke-width='2'/><line x1='8' y1='16' x2='24' y2='16' stroke='black' stroke-width='1'/></svg>`;
                    container.style.cursor = `url('data:image/svg+xml;utf8,${encodeURIComponent(eraserSvg)}') 16 16, auto`;
                } else if (name === 'pan') {
                    btnPan.classList.add('active');
                    container.style.cursor = 'grab';
                }
            }

            btnMarker.addEventListener('click', () => activateTool('marker'));
            btnEraser.addEventListener('click', () => activateTool('eraser'));
            btnPan.addEventListener('click', () => activateTool('pan'));

            colorItems.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    colorItems.forEach(b => b.classList.remove('active'));
                    const target = e.target.closest('.color-item');
                    target.classList.add('active');
                    currentColor = target.dataset.color;
                    activateTool('marker');
                });
            });

            let isGridOn = false;
            document.getElementById('btn-grid').addEventListener('click', function () {
                isGridOn = !isGridOn;
                gridLayer.classList.toggle('visible', isGridOn);
                this.classList.toggle('active', isGridOn);
            });

            document.getElementById('btn-clear').addEventListener('click', () => { strokes = []; render(); });
            document.getElementById('btn-zoom-in').addEventListener('click', () => { camera.zoom = Math.min(camera.zoom * 1.2, 5); render(); });
            document.getElementById('btn-zoom-out').addEventListener('click', () => { camera.zoom = Math.max(camera.zoom / 1.2, 0.1); render(); });
            document.getElementById('btn-zoom-reset').addEventListener('click', () => { camera.zoom = 1; camera.x = 0; camera.y = 0; render(); });

            document.getElementById('btn-save').addEventListener('click', () => {
                if (strokes.length === 0) { alert("Nothing to save!"); return; }
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                strokes.forEach(s => {
                    s.points.forEach(p => {
                        if (p.x < minX) minX = p.x;
                        if (p.x > maxX) maxX = p.x;
                        if (p.y < minY) minY = p.y;
                        if (p.y > maxY) maxY = p.y;
                    });
                });
                const padding = 50;
                minX -= padding; minY -= padding;
                maxX += padding; maxY += padding;
                const w = maxX - minX;
                const h = maxY - minY;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.fillStyle = '#f4f4f4';
                tCtx.fillRect(0, 0, w, h);
                tCtx.translate(-minX, -minY);
                strokes.forEach(stroke => {
                    tCtx.lineWidth = stroke.size;
                    tCtx.lineCap = 'round';
                    tCtx.lineJoin = 'round';
                    if (stroke.isEraser) {
                        tCtx.globalCompositeOperation = 'source-over';
                        tCtx.strokeStyle = '#f4f4f4';
                    } else {
                        tCtx.globalCompositeOperation = 'source-over';
                        tCtx.strokeStyle = stroke.color;
                    }
                    tCtx.beginPath();
                    tCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
                    for (let i = 1; i < stroke.points.length - 2; i++) {
                        const c = (stroke.points[i].x + stroke.points[i + 1].x) / 2;
                        const d = (stroke.points[i].y + stroke.points[i + 1].y) / 2;
                        tCtx.quadraticCurveTo(stroke.points[i].x, stroke.points[i].y, c, d);
                    }
                    const i = stroke.points.length - 2;
                    if (stroke.points.length > 2)
                        tCtx.quadraticCurveTo(stroke.points[i].x, stroke.points[i].y, stroke.points[i + 1].x, stroke.points[i + 1].y);
                    else
                        tCtx.lineTo(stroke.points[0].x, stroke.points[0].y);
                    tCtx.stroke();
                });
                const link = document.createElement('a');
                link.download = `marker-sketch-${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            });
            render();
        }

        document.addEventListener("DOMContentLoaded", () => {
            initPlayground();
            const overlay = document.querySelector('.transition-overlay');
            if (overlay) {
                gsap.to(overlay, { scaleY: 0, duration: 1, ease: "power4.inOut", delay: 0.2 });
            }
            window.goHome = function (e) {
                e.preventDefault();
                if (overlay) {
                    gsap.set(overlay, { transformOrigin: "bottom" });
                    gsap.to(overlay, {
                        scaleY: 1, duration: 0.8, ease: "power4.inOut", onComplete: () => { window.location.href = 'index.html'; }
                    });
                } else {
                    window.location.href = 'index.html';
                }
            };
        });
    </script>
</body>
</html>